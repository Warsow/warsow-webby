#!/bin/bash
set -e
cd "$(dirname "${0}")/.."

export NODE_ENV='local'
PATH="${PATH}:node_modules/.bin"


## --------------------------------------------------------
##  Tasks
## --------------------------------------------------------

task_default() {
  yarn install >&2
  export NODE_ENV='production'
  exec node --experimental-modules src/server/index.mjs "${@}"
}

task_build() {
  yarn install >&2
  export NODE_ENV='production'
  webpack --progress "${@}"
}

task_dev() {
  yarn install >&2
  rm -rf public/bundles
  exec node --experimental-modules src/server/index.mjs "${@}"
}

task_clean() {
  rm -rf node_modules public/bundles
  rm -f yarn-error.log server.socket npm-debug.log package-lock.json
}


## --------------------------------------------------------
##  Option parsing
## --------------------------------------------------------

case ${1} in
  '--build')
    task_build ;;
  '--dev')
    task_dev ;;
  '--clean')
    task_clean ;;
  *)
    task_default ;;
esac

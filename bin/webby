#!/bin/bash
set -e
cd "$(dirname "${0}")/.."

export APP_ENV='local'
PATH="${PATH}:node_modules/.bin"

## Development server
if [[ ${1} == '--dev' ]]; then
  hash nodemon 2>/dev/null && [[ -d node_modules ]] || yarn install
  hash nodemon sassc

  cleanup() {
      trap - INT TERM EXIT
      echo -en "\nSending SIGKILL..."
      kill -9 ${pid_server} 2>/dev/null
      [[ $? -eq 0 ]] && echo -n " server [✓]"
      kill -9 ${pid_make} 2>/dev/null
      [[ $? -eq 0 ]] && echo -n " sass [✓]"
      echo
      exit 0
  }

  trap "cleanup" INT TERM EXIT

  mkdir -p public/styles

  ## Application server
  nodemon --watch src --ext js --quiet src/http/index.js \
    & pid_server="$!"

  ## Sass compiler
  nodemon --watch src --ext scss --quiet --exec \
    sassc src/client/styles/index.scss public/styles/index.css -t expanded -m \
    & pid_make="$!"

  wait
  exit ${?}
fi

## Clean runtime and build artifacts
if [[ ${1} == '--clean' ]]; then
  rm -rf node_modules .esm-cache public/styles
  exit
fi

## Normal server
export APP_ENV='production'
hash node_modules 2>/dev/null || yarn install --production
exec node src/http/index.js "${@}"

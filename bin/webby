#!/bin/bash
set -e
cd "$(dirname "${0}")/.."

export NODE_ENV='local'
PATH="${PATH}:node_modules/.bin"


##  Tasks
## --------------------------------------------------------

task_default() {
  task_install
  export NODE_ENV='production'
  exec node --experimental-modules --no-deprecation packages/warsow-web-server "${@}"
}

task_install() {
  yarn install --production=false >&2
}

task_build() {
  task_install
  export NODE_ENV='production'
  webpack --progress "${@}"
}

task_dev() {
  task_install
  task_clean
  exec nodemon --quiet \
    --watch config \
    --watch packages/warsow-common \
    --watch packages/warsow-livesow \
    --watch packages/warsow-web-server \
    --ext js,mjs,yaml \
    --experimental-modules packages/warsow-web-server "${@}"
}

task_clean() {
  rm -rf public/bundles
  rm -f yarn-error.log npm-debug.log package-lock.json
}

task_dbclean() {
  task_clean
  rm -rf storage
}

task_distclean() {
  task_clean
  rm -rf node_modules packages/*/node_modules storage
}


##  Option parsing
## --------------------------------------------------------

case ${1} in
  '--build') task_build ;;
  '--dev') task_dev ;;
  '--clean') task_clean ;;
  '--dbclean') task_dbclean ;;
  '--distclean') task_distclean ;;
  *) task_default ;;
esac
